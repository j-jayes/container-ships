---
title: "Untitled"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
runtime: shiny
resource_files:
  -data/combined_data.rds
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(shiny)
library(plotly)
library(glue)

df <- read_rds("data/combined_data.rds")

theme_set(theme_light())

```


### Planning

I want to make a flexdashboard that tells a story. 

I want to ask the question, "How big is the Ever Given"?

I want to have a section on the history of cargo ships, and show how big they have become.

Then I want to compare the Ever Given to other container ships.

Then I want to compare it to other large ships.

I want to learn about the storyboard function.

I also want to have a tab that compares the Ever Given to other big things, like a Supertrumps comparison.

Column {data-width=650}
-----------------------------------------------------------------------

### Chart A

```{r}

df %>% 
  mutate(decade = launched - launched %% 10) %>% 
  group_by(decade) %>% 
  summarise(mean_length = median(length, na.rm = T),
            mean_beam = median(beam, na.rm = T),
            mean_tonnage = median(tonnage, na.rm = T)) %>% 
  ungroup() %>% 
  filter(!decade %in% c(NA, 1760)) %>% 
  ggplot(aes(fill = mean_tonnage, 
             xmin = 0, xmax = mean_length,
             ymin = 0, ymax = mean_beam)) +
  geom_rect() +
  scale_fill_viridis_c() +
  facet_wrap(~ decade) +
  labs(x = "Length of average ship",
       y = "Beam of average ship (width at widest point)",
       fill = "Tonnage of average ship") +
  theme(legend.position = "bottom", legend.key.width = unit(2.5, "cm")) +
  guides(fill = guide_colourbar(title.position = "bottom"))

```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}

df %>% 
  filter(launched > 1970) %>% 
  mutate(decade = launched - launched %% 10) %>% 
  mutate(decade = factor(decade)) %>% 
  ggplot(aes(x = tonnage, y = decade, fill = stat(x))) +
    geom_density_ridges_gradient(scale = 3, 
                                 rel_min_height = 0.01, 
                                 gradient_lwd = 1.) +
  scale_x_continuous(labels = scales::number_format()) +
  scale_fill_viridis_c(name = "Deadweight tonnage", option = "C",
                       labels = scales::number_format()) +
  labs(y = "Decade") +
  theme(legend.position = "bottom", legend.key.width = unit(2.5, "cm")) +
  guides(fill = guide_colourbar(title.position = "bottom"))

```

### Chart C

```{r}

df_facet <- df %>% 
  filter(launched > 1970) %>% 
  pivot_longer(c("launched", "length", "beam"),
               names_to = "feature", values_to = "value") %>% 
  mutate(feature = str_to_title(feature)) %>% 
  mutate(feature = factor(feature, 
                          levels = c("Length", "Beam", "Launched"))) %>% 
  mutate(flag = if_else(name == "Ever Given", 1, 0))
  
df_facet %>%   
  ggplot(aes(value, gt, colour = tonnage, group = 1)) +
  geom_smooth(method = "lm", se = T, colour = "grey50") +
  geom_point() +
  geom_point(data = df_facet %>% filter(flag == 1), 
             aes(shape = name), 
             cex = 10,
             show.legend = T) +
  geom_text(data = df_facet %>% filter(flag == 1),
            aes(label = name), show.legend = F, colour = "grey25", size = 3) +
  scale_shape_manual(values = 18) +
  scale_x_continuous(guide = guide_axis(check.overlap = T)) +
  scale_y_continuous(labels = scales::number_format()) +
  facet_wrap(~ feature, scales = "free_x") +
  labs(x = "Value (m)",
       y = "Deadweight tonnage",
       colour = "Deadweight tonnage",
       shape = "Highlight") +
  coord_cartesian(ylim = c(0, NA))

```

